
# QRAN.TOP - دليل البرمجة

## 1. نظرة عامة على المشروع

**الغرض:** تطبيق QRAN.TOP هو مستكشف قرآني متقدم وسريع وغني بالميزات، يعمل كتطبيق ويب تقدمي (PWA). تم تصميمه للدراسة العميقة (التدبر) والتحليل اللغوي، حيث يجمع بين تجربة قراءة جميلة وقدرات بحث قوية.

**التقنيات الأساسية:**
- **إطار العمل:** React
- **اللغة:** TypeScript
- **التنسيق:** Tailwind CSS
- **الواجهة الخلفية وقاعدة البيانات:** Firebase (Firestore) للتعليقات، الإعدادات، والميزات التي تتطلب تحديثاً لحظياً.
- **البناء والتطوير:** تم بناء التطبيق ليعمل مباشرة في المتصفح باستخدام وحدات ES (ES modules) وخريطة استيراد (`importmap`). لا توجد خطوة بناء تقليدية (مثل Webpack أو Vite).

---

## 2. البنية والمفاهيم الأساسية

### 2.1. فلسفة الإصدار المزدوج للقرآن

هذا هو المفهوم الأساسي في التطبيق. لتحقيق كل من تجربة قراءة أصيلة ومحرك بحث قوي، يعتمد التطبيق على إصدارين أساسيين من القرآن:

1.  **`quran-uthmani`**: نص القرآن بالرسم العثماني الأصيل، كاملاً بجميع علامات التشكيل والزخارف.
    - **حالة الاستخدام:** يُستخدم حصرياً لعرض نص القرآن في المكون `SurahDetailView` لتوفير تجربة قراءة مطابقة للمصحف المطبوع.
    - **المصدر:** يتم تحميله مبدئياً من ملف JSON ثابت (`quran-uthmani.json`) للسرعة، ولكن يمكن إدارته عبر Firestore.

2.  **`quran-simple-clean`**: نص القرآن برسم إملائي مبسط وحديث، مع إزالة جميع علامات التشكيل ومعظم العلامات القرآنية.
    - **حالة الاستخدام:** هذا هو نص "محرك البحث". يتم تنفيذ جميع استعلامات البحث للمستخدمين على هذا النص المُنظَّم (normalized)، مما يضمن أن الاختلافات في الرسم أو التشكيل لا تؤثر على نتائج البحث. يُستخدم أيضاً كمصدر بيانات لعرض نتائج البحث.
    - **المصدر:** يتم تحميله من ملف JSON ثابت (`quran-simple-clean.json`).

### 2.2. إدارة الحالة (State Management)

يستخدم التطبيق نمط إدارة حالة مركزي داخل المكون الرئيسي `App.tsx`، معتمداً على خطافات React القياسية (React hooks).

- **`App.tsx` كمصدر الحقيقة الوحيد (Single Source of Truth):** يحتفظ هذا المكون بأهم أجزاء الحالة العامة، بما في ذلك:
    - `allQuranData`: كائن يحتوي على جميع إصدارات القرآن التي تم تحميلها، مفهرسة بمعرفاتها.
    - `currentPath`: يدير توجيه التطبيق بناءً على "hash" عنوان URL.
    - `playbackInfo`: حالة مشغل الصوت العام.
    - إعدادات المستخدم (`selectedFontFamily`, `fontSize`, `activeEditions`, إلخ).

- **التخزين المحلي (Local Storage):** يستخدم للحفاظ على تفضيلات المستخدم بين الجلسات.
    - `qran_app_edition`: معرف إصدار العرض المحدد حالياً.
    - `qran_app_active_editions`: مصفوفة JSON للإصدارات التي اختار المستخدم تفعيلها.
    - `qran_app_selected_font`: عائلة الخط المفضلة لدى المستخدم.
    - `qran_app_font_size`: حجم الخط المفضل لدى المستخدم ('sm', 'md', 'lg').
    - `qran_app_audio_edition`: معرف القارئ الصوتي المختار.
    - `qran_app_collections`: دفتر التدبر الخاص بالمستخدم بالكامل.

- **الخطافات المخصصة (Custom Hooks):** يتم تغليف المنطق في خطافات مخصصة لإعادة الاستخدام وفصل الاهتمامات.
    - `useNotebook.ts`: يدير كل منطق دفتر التدبر (إنشاء/حذف المجموعات، إضافة/إزالة العناصر، الملاحظات، والاستيراد/التصدير عبر Firebase).
    - `useTheme.ts`: يدير المظهر الفاتح/الداكن، بما في ذلك الحفظ في التخزين المحلي واحترام تفضيلات نظام التشغيل للمستخدم.
    - `useRandomPattern.ts`: يختار نمطاً هندسياً إسلامياً خفياً وعشوائياً لعرضه كخلفية لبطاقات المحتوى (فقط في الوضع الفاتح).

### 2.3. تدفق البيانات

1.  **تهيئة التطبيق (`App.tsx`):**
    - يبدأ التطبيق بجلب الإعدادات الهامة من Firestore: `qran_fonts` و `qran_editions`. يستخدم بيانات افتراضية مدمجة (`DEFAULT_FONTS`, `DEFAULT_EDITIONS`) كحل بديل في حالة عدم التمكن من الوصول إلى Firebase.
    - بعد ذلك، يبدأ فوراً في جلب إصداري القرآن الأساسيين (`quran-uthmani`, `quran-simple-clean`) من ملفات JSON ثابتة مستضافة مع التطبيق. هذا يضمن توفر الوظائف الأساسية في أسرع وقت ممكن.
    - يتم عرض `LoadingScreen` (شاشة تحميل) حتى يتم تحميل هذه البيانات الحيوية.

2.  **تحميل البيانات عند الطلب:**
    - عندما يختار المستخدم إصدار عرض جديد (مثل تفسير أو ترجمة إنجليزية) لم يتم تحميله بعد، يتم استدعاء `fetchCustomEditionData`.
    - تحدد هذه الدالة بذكاء عنوان URL الصحيح لواجهة برمجة التطبيقات (API) بناءً على خاصية `sourceApi` للإصدار (`alquran.cloud`, `fawazahmed0`, أو عنوان URL مخصص).
    - تتم معالجة البيانات التي تم جلبها (بما في ذلك خطوة تنظيف البسملة) وإضافتها إلى كائن الحالة `allQuranData`.
    - يشير `TopProgressBar` إلى نشاط التحميل.

### 2.4. التوجيه (Routing)

يستخدم التطبيق نظام توجيه بسيط يعتمد على الـ "hash"، تتم إدارته من خلال الاستماع إلى حدث `hashchange` في `App.tsx`. يتم تحديث متغير الحالة `currentPath`، مما يؤدي إلى إعادة عرض الدالة `renderContent`.

- **`#/`**: الصفحة الرئيسية (فهرس السور).
- **`#/surah/{number}`**: يعرض سورة معينة.
- **`#/search/{query}`**: يعرض نتائج البحث عن استعلام نصي.
- **`#/search/number/{number}`**: يعرض نتائج البحث عن رقم آية.
- **`#/settings`**: صفحة الإعدادات.
- **`#/saved`**: الصفحة الرئيسية لدفتر التدبر.
- **`#/saved/{collectionId}`**: مجموعة معينة في دفتر التدبر.
- **`#/comments`**: عرض النقاشات الشائعة (سحابة الكلمات).
- **`#/khatmiyah`**: الصفحة الرئيسية لميزة الختمة الجماعية.
- **`#/khatmiyah/{id}`**: جلسة ختمة جماعية معينة.
- **`#/admin`**: لوحة تحكم المشرف (يتم الوصول إليها عبر تسلسل نقرات سري).

---

## 3. تفصيل المكونات

### 3.1. العروض الرئيسية (Main Views)

- **`App.tsx`**: المكون المُنظِّم. يحتوي على منطق التوجيه الرئيسي (`renderContent`)، الرأس (Header)، ويقوم بتهيئة كل عمليات جلب البيانات والحالة.
- **`SurahDetailView.tsx`**: يعرض سورة كاملة. الميزات الرئيسية:
    - النقر على كلمة يؤدي إلى بحث عنها.
    - النقر على رقم الآية `﴿﴾` يفتح نافذة منبثقة بها إجراءات (حفظ، نسخ، بحث).
    - ينتقل إلى الآية المحددة إذا تم تحديدها في عنوان URL (`?ayah=...`).
    - يتكامل مع عناصر التحكم في مشغل الصوت.
- **`SearchView.tsx`**: مكون معقد يعالج تجربة البحث بأكملها.
    - يعرض النتائج مع تمييز كلمة البحث.
    - يقدم اقتراحات "كلمات مجاورة" لبناء عمليات بحث مركبة.
    - يسمح بالمطابقة التامة.
    - يحتوي على قسم للنقاش (`DiscussionSection.tsx`) للتفاعل المجتمعي حول موضوع البحث.
    - يوفر أدوات لتصدير أو تشغيل جميع النتائج.
- **`SettingsView.tsx`**: واجهة مبوبة لإدارة:
    - **الخطوط:** معرض مرئي للخطوط المتاحة.
    - **الإصدارات:** مدير قائم على البطاقات لإضافة/إزالة إصدارات القرآن والتفاسير والترجمات.
    - **مزامنة الدفتر:** واجهة المستخدم لميزة الاستيراد والتصدير.
    - **تنسيق التصدير:** محرر قوالب لتخصيص المخرجات النصية لنتائج البحث.
- **`SavedView.tsx`**: يعرض دفتر التدبر الخاص بالمستخدم، مما يسمح بالتنقل داخل المجموعات وتعديل الملاحظات على العناصر المحفوظة.
- **`KhatmiyahView.tsx`**: واجهة المستخدم لميزة الختمة الجماعية. لها حالتان رئيسيتان: عرض رئيسي لإنشاء/الانضمام إلى الجلسات وعرض لوحة معلومات للمشاركة في جلسة نشطة.
- **`AdminView.tsx`**: لوحة محمية بكلمة مرور لمشرفي الموقع لإدارة المحتوى الذي ينشئه المستخدمون (التعليقات) وإعدادات التطبيق (الخطوط، المصادر).

### 3.2. مكونات الواجهة والتخطيط

- **`SidePanel.tsx`**: قائمة التنقل الجانبية الرئيسية القابلة للسحب، توفر وصولاً سريعاً إلى جميع أقسام التطبيق الرئيسية والصفحات المعلوماتية.
- **`Toolbox.tsx`**: شريط أدوات عائم يظهر في `SurahDetailView` و `SearchView`. يوفر وصولاً سريعاً لتغيير حجم الخط، عائلة الخط، وإصدار العرض الحالي. يختفي بذكاء عند التمرير لأسفل ويظهر مرة أخرى عند التمرير لأعلى.
- **`AudioPlayerBar.tsx`**: الشريط الدائم في أسفل الشاشة الذي يظهر عند تشغيل الصوت. يعرض القارئ الحالي والسورة ويوفر عناصر تحكم في التشغيل.
- **`SurahListItem.tsx`**: مكون البطاقة لكل سورة في الصفحة الرئيسية.
- **`LoadingScreen.tsx`**: شاشة تحميل متحركة مع شعار يمتلئ وعداد نسبة مئوية، تظهر عند التحميل الأولي للتطبيق.

### 3.3. المكونات المتخصصة والبيانات

- **`DiscussionSection.tsx`**: مكون غلافي يعالج منطق فتح النقاش وتمرير `topicId` الصحيح لمكونات التعليقات.
- **`comments/*`**: مجموعة من المكونات لنظام التعليقات المجهول.
    - `CommentForm.tsx`: نموذج الإدخال لإرسال تعليقات/ردود جديدة.
    - `CommentsList.tsx`: يجلب ويعرض شجرة التعليقات لموضوع معين من Firestore.
    - `Comment.tsx`: يعرض تعليقاً واحداً وردوده، ويتعامل مع إجراءات مثل الإبلاغ.
- **`firebase.ts`**: يقوم بتهيئة الاتصال بـ Firebase وتصدير نسخة `db` (Firestore). هذه هي النقطة المركزية لجميع تفاعلات قاعدة البيانات.
- **`types.ts`**: يحتوي على جميع واجهات TypeScript لهياكل بيانات التطبيق (`Surah`, `Ayah`, `QuranEdition`, `Comment`, إلخ)، مما يضمن سلامة الأنواع (type safety) عبر المشروع.
- **`utils/text.ts`**: يحتوي على دوال مساعدة، وأهمها `normalizeArabicText`، وهي حاسمة لوظيفة البحث.

---

## 4. المنطق والخوارزميات الرئيسية

### 4.1. خوارزمية البحث (`performSearch` في `App.tsx`)

1.  **التنظيم (Normalization):** يتم تنظيم استعلام المستخدم ونص القرآن باستخدام `normalizeArabicText` لإزالة علامات التشكيل وتوحيد أشكال الحروف المختلفة (على سبيل المثال، جميع أشكال "الألف" تصبح واحدة).
2.  **اختيار الإصدار:**
    - إذا كان الاستعلام يحتوي على علامات تشكيل، تتم محاولة البحث أولاً في إصدار `quran-uthmani` للحصول على تطابق دقيق.
    - إذا لم يتم العثور على نتائج، أو إذا كان الاستعلام لا يحتوي على تشكيل، فإنه يعود للبحث في إصدار `quran-simple-clean`. هذا يوفر أفضل ما في العالمين: الدقة عند الحاجة، والشمولية في الحالات الأخرى.
3.  **مكتشف الآيات (Verse Finder - استدلال متقدم):**
    - للاستعلامات الطويلة (أكثر من 4 كلمات مع تشكيل)، يتم تشغيل منطق "مكتشف الآيات" الخاص.
    - يقوم بإنشاء "بصمة" للاستعلام (سلسلة مستمرة من الحروف بدون مسافات أو تشكيل).
    - ثم يبحث بشكل متكرر عن هذه البصمة داخل بصمات جميع الآيات، مضيفًا كلمة واحدة في كل مرة إلى الاستعلام.
    - تم تصميم هذا الاستدلال لتقليص النتائج بسرعة إلى آية فريدة واحدة، حتى لو كان إدخال المستخدم جزءًا من آية.
4.  **النتائج:** تُرجع الدالة الآيات المطابقة والإصدار الذي تم استخدامه بنجاح في البحث (`finalSearchEdition`).

### 4.2. منطق الختمة (`KhatmiyahView.tsx`)

- **إدارة الحالة:** يتم تخزين حالة كل ختمة في مستند واحد في Firestore. حقل `juz_status` هو خريطة (map) من 30 كائنًا، يمثل كل منها حالة جزء.
- **المعاملات (Transactions):** تستخدم معاملات Firestore للعمليات الحرجة مثل حجز جزء. هذا يضمن عدم تمكن مستخدمين اثنين من حجز نفس الجزء في وقت واحد (تحديثات ذرية - atomic updates).
- **مكافحة البريد العشوائي (Anti-Spam):** متتبع قائم على التخزين المحلي (`KHATMIYAH_ACTION_TRACKER_KEY`) يحد من عدد عمليات الإنشاء والحجز والإتمام التي يمكن لمستخدم واحد إجراؤها يومياً لمنع إساءة الاستخدام.
- **التنظيف التلقائي:** يتم تشغيل دالة تنظيف (`deleteInactiveKhatmahs`) بشكل دوري لإزالة الختمات القديمة وغير النشطة من قاعدة البيانات للحفاظ على نظافتها.

---

## 5. كيفية توسيع التطبيق

### 5.1. إضافة إصدار قرآن/تفسير جديد

1.  **الإضافة إلى Firestore:** الطريقة المفضلة هي إضافة مستند جديد إلى مجموعة `qran_editions` في قاعدة بيانات Firestore بالمخطط الصحيح (نوع `QuranEdition`).
2.  **الإضافة إلى `DEFAULT_EDITIONS` (كحل بديل):** للإصدارات الأساسية أو إذا لم يتم استخدام Firebase، أضف كائن الإصدار إلى مصفوفة `DEFAULT_EDITIONS` في `App.tsx`.
3.  **توفير البيانات:** تأكد من أن بيانات الإصدار الجديد متاحة على عنوان URL المحدد بواسطة `sourceApi` و `identifier`. بالنسبة لـ `fawazahmed0`، هذا تلقائي. بالنسبة لـ `alquran.cloud`، يتطلب أن تدعم الواجهة البرمجية هذا المعرف. بالنسبة لعناوين URL المخصصة، يجب عليك استضافة ملف JSON بنفسك.

### 5.2. إضافة خط جديد

1.  **الإضافة إلى Firestore:** أضف مستندًا جديدًا إلى مجموعة `qran_fonts` بالمخطط الصحيح (نوع `QuranFont`)، بما في ذلك `url` لملف الخط (على سبيل المثال، من Google Fonts).
2.  **الإضافة إلى `DEFAULT_FONTS` (كحل بديل):** أضف كائن الخط إلى مصفوفة `DEFAULT_FONTS` في `App.tsx`.
3.  سيقوم التطبيق تلقائياً بإنشاء وسم `<link>` لتحميل CSS الخاص بالخط من عنوان URL المحدد.

### 5.3. إضافة صفحة/عرض جديد

1.  أنشئ ملف المكون الجديد (على سبيل المثال، `components/NewView.tsx`).
2.  في `App.tsx`، أضف معالج مسار جديد داخل دالة `renderContent`.
    ```tsx
    // داخل renderContent() في App.tsx
    if (pathParts[0] === 'new-view') {
        return <NewView />;
    }
    ```
3.  أضف رابطاً للعرض الجديد في مكون `SidePanel.tsx`.
